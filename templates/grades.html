{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">

      <h2 class="mb-4">ğŸ“Š æˆç¸¾ç™»éŒ²</h2>

      <form method="post" class="mb-5">
        <div class="mb-3">
          <label class="form-label">æˆæ¥­å</label>
          <input type="text" name="class_name" class="form-control" required>
        </div>

        <div id="items">
          <div class="row g-2 mb-2 item">
            <div class="col-md-7">
              <input type="text" name="item_name[]" class="form-control" placeholder="é …ç›®å" required>
            </div>
            <div class="col-md-5">
              <input type="number" name="weight[]" class="form-control" placeholder="å‰²åˆï¼ˆ%ï¼‰" required>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addItem()">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
        <div class="d-grid">
          <input type="submit" value="ç™»éŒ²" class="btn btn-primary">
        </div>
      </form>

      <h3 class="mb-3">âœ… ç™»éŒ²æ¸ˆã¿ã®æˆç¸¾</h3>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>æˆæ¥­å</th>
              <th>é …ç›®ã¨å‰²åˆ</th>
              <th>å¾—ç‚¹</th>
              <th>åˆè¨ˆç‚¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for grade in grades %}
            <tr>
              <td>{{ grade.class_name }}</td>
              <td>
                <ul class="list-unstyled mb-0">
                  {% for item in grade["items"] %}
                    <li>{{ item.name }}ï¼š{{ item.weight }}%</li>
                  {% endfor %}
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-0">
                  {% for item in grade["items"] %}
                    <li>
                      {% if item.score is not none %}
                        {{ item.score }}ç‚¹
                      {% else %}
                        <em>æœªå…¥åŠ›</em>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </td>
              <td>
                {% set ns = namespace(subtotal=0, complete=true) %}
                {% for item in grade["items"] %}
                  {% if item.score is not none %}
                    {% set ns.subtotal = ns.subtotal + item.score * (item.weight / 100) %}
                  {% else %}
                    {% set ns.complete = false %}
                  {% endif %}
                {% endfor %}
                {% if ns.complete %}
                  {{ ns.subtotal | round(1) }}
                {% else %}
                  ä»®è¨ˆï¼š{{ ns.subtotal | round(1) }}ï¼ˆæœªå®Œï¼‰
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('edit_grade', index=loop.index0) }}" class="btn btn-sm btn-outline-primary">ç·¨é›†</a>
                <a href="{{ url_for('delete_grade', index=loop.index0) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">å‰Šé™¤</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script>
function addItem() {
  const container = document.getElementById('items');
  const div = document.createElement('div');
  div.className = 'row g-2 mb-2 item';
  div.innerHTML = `
    <div class="col-md-7">
      <input type="text" name="item_name[]" class="form-control" placeholder="é …ç›®å" required>
    </div>
    <div class="col-md-5">
      <input type="number" name="weight[]" class="form-control" placeholder="å‰²åˆï¼ˆ%ï¼‰" required>
    </div>
  `;
  container.appendChild(div);
}
</script>
{% endblock %}
