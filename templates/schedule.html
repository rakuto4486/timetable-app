{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">

      <!-- ğŸ—“ æ™‚é–“å‰²è¡¨ã‚’å…ˆã«è¡¨ç¤º -->
      <h2 class="mb-3">ğŸ“… æ™‚é–“å‰²è¡¨</h2>

      <div class="table-responsive mb-5">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 10%;">æ™‚é™ï¼¼æ›œæ—¥</th>
              <th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th>
            </tr>
          </thead>
          <tbody>
            {% for period in range(1, 6) %}
            <tr>
              <th>{{ period }}é™</th>
              {% for day in ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'] %}
              <td class="schedule-cell" style="position: relative;">
                {% set found = false %}
                {% for item in schedule %}
                  {% if not found and item.day == day and item.period == period %}
                    <div 
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="{{ item.class_name }} | {{ item.room }} | {{ item.teacher }}"
                      class="text-truncate small"
                      style="max-width: 100%; white-space: nowrap; overflow: hidden;"
                    >
                      <strong>{{ item.class_name }}</strong>
                    </div>
                    <div class="text-muted small">({{ item.room }})</div>
                    <div class="text-muted small">{{ item.teacher }}</div>
              
                    {% for grade in grades %}
                      {% if grade.class_name == item.class_name and grade.get("items") %}
                        <div class="text-muted small">
                          æˆç¸¾ï¼š
                          {% if grade.total_score is not none %}
                            {{ grade.total_score }}
                          {% else %}
                            {% set ns = namespace(subtotal=0, complete=true) %}
                            {% for g in grade.items %}
                              {% if g.score is not none %}
                                {% set ns.subtotal = ns.subtotal + (g.score * (g.weight / 100)) %}
                              {% else %}
                                {% set ns.complete = false %}
                              {% endif %}
                            {% endfor %}
                            ä»®è¨ˆï¼š{{ ns.subtotal | round(1) }}ï¼ˆæœªå®Œï¼‰
                          {% endif %}
                        </div>
                      {% endif %}
                    {% endfor %}
              
                    <div class="d-grid mt-1">
                      <a href="{{ url_for('delete_schedule', index=loop.index0) }}" class="btn btn-outline-danger btn-sm">å‰Šé™¤</a>
                    </div>
                    {% set found = true %}
                  {% endif %}
                {% endfor %}
              </td>
              
              
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ğŸ”½ æ™‚é–“å‰²ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
      <button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#scheduleForm">
        ï¼‹ æ™‚é–“å‰²ã‚’ç™»éŒ²
      </button>

      <div class="collapse" id="scheduleForm">
        <h2 class="mb-4">ğŸ“š æ™‚é–“å‰²ç™»éŒ²</h2>

        {% if error %}
          <div class="alert alert-danger" role="alert">
            {{ error }}
          </div>
        {% endif %}

        <form method="post" class="row g-3 mb-5">
          <div class="col-md-6">
            <label class="form-label">æˆæ¥­å</label>
            <input type="text" name="class_name" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ›œæ—¥</label>
            <select name="day" class="form-select">
              <option>æœˆ</option><option>ç«</option><option>æ°´</option><option>æœ¨</option><option>é‡‘</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ™‚é™</label>
            <select name="period" class="form-select">
              <option value="1">1é™</option><option value="2">2é™</option>
              <option value="3">3é™</option><option value="4">4é™</option>
              <option value="5">5é™</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">æ•™å®¤</label>
            <input type="text" name="room" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">æ•™å“¡å</label>
            <input type="text" name="teacher" class="form-control">
          </div>
          <div class="col-12 d-grid">
            <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

{% endblock %}
